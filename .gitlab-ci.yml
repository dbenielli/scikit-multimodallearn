# run the test suite
tests:
    image: docker:20.10.16
    services:
        - docker:dind
    variables:
        DOCKER_TLS_CERTDIR: ""  # Désactive l'utilisation des certificats TLS dans Docker-in-Docker
        DOCKER_HOST: tcp://docker:2375
        DOCKER_DRIVER: overlay2
    before_script:
        - echo "Configuring Docker to use insecure registry"
        - mkdir -p /etc/docker  # Crée le répertoire Docker si nécessaire
        - echo '{"insecure-registries":["registry.gitlab.lis-lab.fr:5005"]}' > /etc/docker/daemon.json
        - dockerd &  # Démarre le démon Docker
        - docker login registry.gitlab.lis-lab.fr:5005 -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    script:
        - docker pull registry.gitlab.lis-lab.fr:5005/dev/scikit-multimodallearn/ubuntu:22.04
        - docker run registry.gitlab.lis-lab.fr:5005/dev/scikit-multimodallearn/ubuntu:22.04 python3 setup.py install
        - docker run registry.gitlab.lis-lab.fr:5005/dev/scikit-multimodallearn/ubuntu:22.04 pytest-3
    coverage: '/^TOTAL.+?(\d+\%)$/'
    artifacts:
      paths:
        - htmlcov/



# generate the documentation
doc:
    image: registry.gitlab.lis-lab.fr:5005/dev/scikit-multimodallearn/ubuntu:22.04
    tags:
        - docker
    only:
        - master
    script:
        - export LC_ALL=$(locale -a | grep en_US)
        - export LANG=$(locale -a | grep en_US)
        - pip3 install -e .[doc]
        - rm -Rf build
        - python3 setup.py build_sphinx
    artifacts:
        paths:
          - public

#        - python3 setup.py build_sphinx

# project public
#
pages:
    image: registry.gitlab.lis-lab.fr:5005/dev/scikit-multimodallearn/ubuntu:22.04
    tags:
        - docker
    only:
        - master
    script:
        - export LC_ALL=$(locale -a | grep en_US)
        - export LANG=$(locale -a | grep en_US)
        - pip3 install -e .[doc]
        - python3 setup.py build_sphinx
        - cp -r build/sphinx/html public
    artifacts:
        paths:
          - public
